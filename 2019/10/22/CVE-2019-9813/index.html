<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="“一个不像二进制同学的博客。”"><title>CVE-2019-9813 | f01965</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'true';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
  </script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CVE-2019-9813</h1><a id="logo" href="/.">f01965</a><p class="description">初闻不知曲中意，再听已是曲中人。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CVE-2019-9813</h1><div class="post-meta">Oct 22, 2019<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/2019/10/22/CVE-2019-9813/#vcomment"><span class="valine-comment-count" data-xid="/2019/10/22/CVE-2019-9813/"></span><span> 条评论</span></a><div class="post-content"><p>该漏洞参加了 2019 pwn2own 攻下firefox（另一个CVE-2019-9810），POC 有2个获取途径：</p>
<ol>
<li>ZDI 文章：<br><a href="https://www.zerodayinitiative.com/blog/2019/4/18/the-story-of-two-winning-pwn2own-jit-vulnerabilities-in-mozilla-firefox" target="_blank" rel="noopener">https://www.zerodayinitiative.com/blog/2019/4/18/the-story-of-two-winning-pwn2own-jit-vulnerabilities-in-mozilla-firefox</a></li>
<li>Github :<br><a href="https://github.com/tunz/js-vuln-db/blob/master/spidermonkey/CVE-2019-9813.md" target="_blank" rel="noopener">https://github.com/tunz/js-vuln-db/blob/master/spidermonkey/CVE-2019-9813.md</a></li>
</ol>
<p>漏洞成因，根据ZDI所说：<br>该漏洞是通过2017年的commit 1c43dd975e76c0aa7e5a84af36844d247baf671a引入的，该漏洞禁用了<strong>js :: AddPropertyTypesAfterProtoChange（）</strong>函数中的<strong>unknown-properties</strong>标志的副本。 这会导致缺少对象的<strong>shape/group </strong>检查，然后可以利用该检查来生成已编译的JS函数，该函数会将对象视为具有不同类型的对象，并可能导致类型混淆。</p>
<h3><span id="github-poc">Github POC</span></h3><p>先根据github上的POC来分析：<br> <img src="1.png" alt=""></p>
<p>因为漏洞的类型是对象混淆，图中混淆是就是 X 与 Y 对象。<br>X 是一个 Uint32Array ，Y 可以理解为是一个函数。<br>Pwn() 函数用来触发漏洞。 Hax 函数是关键函数，来达到混淆的目的。</p>
<p>首先，使用大循环调用 <strong>hax({}, false)</strong> 。这样做，是先让<strong>IonMonkey</strong> 确定 <strong>o.p</strong> 的类型，它的属性也就是 Y 的 a1 ，a2 等属性是可修改的。<br>之后，定义变量 <strong>evilObj</strong> ，调用 <strong>evilObj = hax({}, true)</strong> ，同由jit编译为汇编代码在内存中，然后执行<br> <strong>o.p = X ，o.<strong>proto</strong> = {};</strong><br>这个时候，o.p 被修改为 X 类型，也就是 <strong>Uint32Array</strong>，然后 <strong>o.<strong>proto</strong> </strong>的原型被赋值为空对象，此原型更改将导致在每次执行时分配一个新的<strong>ObjectGroup</strong> （因为原型存储在ObjectGroup中）。在创建新的ObjectGroup的过程中，由于jit的缘故，当前属性值 X 的属性，将用于推断对象 o 的属性类型。因此，o将具有推断的类型<strong>{.p：[X]}</strong></p>
<p>然后if执行完，出来继续执行 <strong>o.p = Y</strong>  ，由于jit缘故，它进行了类型推断，而不是检查，那么o 类型不会进行修改，但是内容指向 Y 中的内容。</p>
<p>紧接着 <strong>eval(‘evilObj.p’);</strong> ，触发一下，也就是执行 .p ，然后使其类型被确定下来，也就是说在 shape/group 写下类型。(js 中对一个对象的类型判断，就在 <strong>shape/group</strong> 这2个结构中)。</p>
<p>然后，调用<strong>pwn(evilObj, false);</strong> ，使用 jit 来编译 pwn 这个函数，为后续调用<strong>result = pwn(evilObj, true);</strong> 做准备。<br>因为这里使用false 没有调用 .p 属性，所以不会对 o 进行类型检查，那么jit 在将其编译为汇编代码。<br>最后调用<strong>result = pwn(evilObj, true);</strong>  ，这就会触发 <strong>return o.p[0];</strong> ，那么 o 的类型没有进行检查，就是 X 类型，但是里面的内容为Y 的内容，就造成了类型混淆。<br>实际类型是 X ，但是里面的内容是 Y 的内容。</p>
<p>崩溃如下：<br> <img src="2.png" alt=""></p>
<p>这个poc 的问题是，只能任意读，不能写。<br>也就是 pwn 函数的问题。因为pwn 函数单独在hax 函数外，所以，用jit 编译了pwn 函数之后，return o.p[0];  它只会返回 Y 对象在内存中的地址。</p>
<p>最初打算对pwn函数进行修改:<br> <img src="3.png" alt=""><br>但是这里进行赋值不能修改到 Y 的内容的。我们前面说， o 的类型是 X 类型，内容是 Y的内容。这里进行赋值的它会赋值到 o 这个对象的.p 上，这个 .p 属性，不是 X ，Y 对象中混淆的 .p 属性，是 o 的 .p 属性。<br>所以这个 poc 不能写，那就没办法做到溢出了。但是可以修改一下，就像下面将说的。</p>
<p>###ZDI POC<br> <img src="3.png" alt=""><br>ZDI 这个 POC 就很不错。</p>
<p>根据ZDI 自己的说法：该漏洞两次触发漏洞。 第一次触发它时，它被用作指向双精度型指针（pointer-to-double）的混淆，从而泄漏对象地址。 第二次以相反的方式触发它，这是双指针类型（double-to-pointer）的混淆，产生了任意的读/写 primitive。<br>那么，我们来分析：</p>
<ul>
<li>opt(x) 是用来修改内容的函数</li>
<li>G 函数是触发漏洞的关键函数</li>
<li>proto1 ，proto2 是2个空对象</li>
<li>o1 是 Uint32Array</li>
<li>o2 可以理解成是一个函数</li>
</ul>
<p>首先，g(proto1); 第一次触发，看看 g 函数中会发生什么。<br><strong>n.a = o1</strong>， 被赋值为 o1 的类型。<br>然后定义 hack 变量为一个函数，<strong>n.<strong>proto</strong> = proto;</strong>  原型修改为 proto ，返回的 o2 对象，o2是一个函数。<br>定义 f 变量为一个函数，for循环，强制使用jit，再<strong>n.a = hack();</strong> 把 .a 属性修改为 hack() 函数的返回值，那就是 o2 。<br>接着，执行 f() 函数。</p>
<p>F() 函数执行，由于for循环的存在，就有jit参与，hack () 执行的时候，<strong>n.<strong>proto</strong></strong>被修改，返回了 o2 ，然后赋值给 n.a ，这里就会进行类型推断，先判断 hack() 函数返回的 o2 ，它是一个函数类型，然后会把 n.a 的类型就直接推断是函数类型。</p>
<p>然后使用opt(n) 进行赋值，相当于修改 Y 元素的值，意思是把 Y 当成数组，修改Y[0] 的值。<br> <img src="4.png" alt=""><br>在第二次触发前，有个 for 循环。<br> <img src="5.png" alt=""><br>这里jit 也会参与，那么这个变量 n ，由于类型推断，它的 a：o1 是Uint32Array，所以n会被当成Uint32Array，那么 opt(n) 就是把 n 当成数组进行计算。</p>
<p>第二次触发，g(proto2);<br>由于上面的for循环，类型推断 n 是 o1 的类型，再次进入到 g 函数，<br>n.a = o1; 符合前面的类型推断，</p>
<p>然后调用 f 函数，f 函数调用hack() 函数，由于前面推断了 n 是 o1类型，所以hack()里面 n.<strong>proto</strong> = proto; 重置函数原型，那 n 也会被推断为是 o1类型，但是返回的对象却是 o2 。<br>这里： n.a 被推断为 o1 类型，但是值被改变为 o2 的值。<br>最后，再使用opt(n)，先前的 for 中使用了这个，它这里判断 n 的类型也是 o1 的类型，与先前 for 循环中使用时类型一致，所以直接就用之前jit编译好的代码进行赋值操作。<br>实际上，它这里操作的是 o2 的内容了。那么， x.a[0] 就是操作的 o2 中 e 位置处，它会e位置当成一个uint32Array对象，给下标0进行赋值。<br>那么，在e 这里方上一个 ArrayBuffer 对象，就能修改ArrayBuffer的长度，数据指针等。<br>最方便的方式就是修改ArrayBuffer的长度，这样获得一个溢出的ArrayBuffer，就可以进行下一步利用。<br> <img src="6.png" alt=""></p>
<h3><span id="利用">利用</span></h3><p>利用就比较简单了，根据上面所说，得到一个长度溢出的ArrayBuffer，byteLength被改为84848484 ，修改临近的另一个 ArrayBuffer，byteLength改为0x1000，用这2个进行任意地址读写，剩下的操作就水到渠成了。<br> <img src="7.png" alt=""><br>关闭沙盒，弹Cmd。<br><img src="8.png" alt=""></p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/mePic.jpg&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/漏洞利用/">漏洞利用</a></div><div class="post-nav"><a class="pre" href="/2019/11/07/firefox数据结构/">firefox数据结构</a><a class="next" href="/2019/09/19/x86-11707/">x86 11707</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'o3qEIvAEzJfA0jPzjvyVeUwo-gzGzoHsz',
  appKey:'VBV3VN2vtqwbGqHGFeNL86iw',
  placeholder:'thanks for you read',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://f01965.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE-2018/">CVE / 2018</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志/">日志</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/固件/" style="font-size: 15px;">固件</a> <a href="/tags/CTF-web/" style="font-size: 15px;">CTF-web</a> <a href="/tags/技术分享/" style="font-size: 15px;">技术分享</a> <a href="/tags/机器学习框架/" style="font-size: 15px;">机器学习框架</a> <a href="/tags/漏洞利用/" style="font-size: 15px;">漏洞利用</a> <a href="/tags/Mircosoft/" style="font-size: 15px;">Mircosoft</a> <a href="/tags/漏洞分析/" style="font-size: 15px;">漏洞分析</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/技术分享-固件/" style="font-size: 15px;">技术分享/固件</a> <a href="/tags/fuzz/" style="font-size: 15px;">fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/07/30/730/">730</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/04/10/CVE-2018-5146/">CVE-2018-5146</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/02/24/2021总结/">2021总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/25/fortigate-Vulnerability/">fortigate Vulnerability</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/23/watchguard/">watchguard</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/18/fortigate/">fortigate</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介3/">spiderMonkey 漏洞利用简介3</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介2/">spiderMonkey 漏洞利用简介2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介/">spiderMonkey 漏洞利用简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/07/winAFL实践/">winAFL实践</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://yan-1-20.github.io/about/" title="Asprose" target="_blank">Asprose</a><ul></ul><a href="https://www.lucifaer.com/" title="Lucifaer" target="_blank">Lucifaer</a><ul></ul><a href="http://drac0nids.top/" title="Drac0nids" target="_blank">Drac0nids</a><ul></ul><a href="http://balis0ng.com/" title="balis0ng" target="_blank">balis0ng</a><ul></ul><a href="https://da7uran0ir.github.io/" title="Da7ura_n0ir" target="_blank">Da7ura_n0ir</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"> Dad ， I will always love you.</div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" color="255,0,0" opacity="0.7" zIndex="-1" count="100" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>