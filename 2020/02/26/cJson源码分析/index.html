<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="“一个不像二进制同学的博客。”"><title>cJson源码分析 | f01965</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'true';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
  </script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">cJson源码分析</h1><a id="logo" href="/.">f01965</a><p class="description">初闻不知曲中意，再听已是曲中人。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">cJson源码分析</h1><div class="post-meta">Feb 26, 2020<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/2020/02/26/cJson源码分析/#vcomment"><span class="valine-comment-count" data-xid="/2020/02/26/cJson源码分析/"></span><span> 条评论</span></a><div class="post-content"><h1 id="cJosn"><a href="#cJosn" class="headerlink" title="cJosn"></a>cJosn</h1><p>看 cJson 源码之前，先了解下 Json 的格式。</p>
<h3 id="json-格式"><a href="#json-格式" class="headerlink" title="json 格式"></a>json 格式</h3><p>官方中文翻译：<a href="http://www.json.org/json-zh.html" target="_blank" rel="noopener">http://www.json.org/json-zh.html</a></p>
<p>Json 数据的核心就是 <strong>“key - value”</strong>，也就是 <strong>“名 - 值”</strong>，这个对应关系。  </p>
<p>下面摘自官方说明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JSON建构于两种结构：</span><br><span class="line"></span><br><span class="line">“名称/值”对的集合（A collection of name/value pairs）。不同的语言中，它被理解为对象（object），纪录（record），结构（struct），字典（dictionary），哈希表（hash table），有键列表（keyed list），或者关联数组 （associative array）。</span><br><span class="line">值的有序列表（An ordered list of values）。在大部分语言中，它被理解为数组（array）。</span><br><span class="line">这些都是常见的数据结构。事实上大部分现代计算机语言都以某种形式支持它们。这使得一种数据格式在同样基于这些结构的编程语言之间交换成为可能。</span><br></pre></td></tr></table></figure></p>
<h4 id="JSON-的数据类型如下"><a href="#JSON-的数据类型如下" class="headerlink" title="JSON 的数据类型如下"></a>JSON 的数据类型如下</h4><ol>
<li>object 对象</li>
<li>array，值（value）的有序集合</li>
<li>value，可以是双引号括起来的字符串（string）、数值(number)、true、false、 null、对象（object）或者数组（array）。可以嵌套</li>
<li>string，由双引号包围的任意数量Unicode字符的集合，使用反斜线转义</li>
<li>number 数值</li>
<li>空白，也就是空格。</li>
</ol>
<blockquote>
<p>下面，假设我们来写这个cJson，如何设计。从这个角度，来分析cJson的源码。</p>
</blockquote>
<h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>前面提到了 json 的数据类型，那么对其进行定义，源码头文件 cJosn.h 中。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* cJSON Types: */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_False 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_True 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_NULL 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_Number 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_String 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_Array 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_Object 6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_IsReference 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_StringIsConst 512</span></span><br></pre></td></tr></table></figure></p>
<p>源码中用 define 。如果大家看过 effective C++ 这本书，书中的建议是尽量用 const enum inline 代替。<br>那这里可以用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const int cJSON_False = 0;</span><br><span class="line">...</span><br><span class="line">或者</span><br><span class="line">enum&#123;cJSON_False, cJSON_True, cJSON_NULL, cJSON_Number, cJSON_String, cJSON_Array, cJSON_Object, cJSON_IsReference=256, cJSON_StringIsConst=512&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>接着源码中定义了一个名为 cJson 的结构体，来描述 json 数据的每个节点。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/* The cJSON structure: */</span><br><span class="line">typedef struct cJSON &#123;</span><br><span class="line">	struct cJSON *next,*prev;	/* prev/next 就是前后链表指针 */</span><br><span class="line">	struct cJSON *child;		/* 子节点指针 */</span><br><span class="line"></span><br><span class="line">	int type;					/* key 的类型，也就上面 define 定义的 */</span><br><span class="line"></span><br><span class="line">	char *valuestring;			/* 字符串值 */</span><br><span class="line">	int valueint;				/* 整数值 */</span><br><span class="line">	double valuedouble;			/* 浮点数值 */</span><br><span class="line"></span><br><span class="line">	char *string;				/* key 的名字 */</span><br><span class="line">&#125; cJSON;</span><br></pre></td></tr></table></figure></p>
<p>这里可以明白，cJson用链表来处理存储数据，访问方式类似一棵树。</p>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>在 c 语言中内存分配和释放一般用 malloc 和 free 。这里 cjson 使用 Hook 来让我们可以自定义 malloc 和 free，来进行管理。我们可以 cJSON_InitHooks  函数替换默认使用的 malloc ，free。源码中的函数声明和定义分开了，我放在下面一起好看。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cJSON_Hooks</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *(*malloc_fn)(<span class="keyword">size_t</span> sz);</span><br><span class="line">    <span class="keyword">void</span> (*free_fn)(<span class="keyword">void</span> *ptr);</span><br><span class="line">&#125; cJSON_Hooks;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *(*cJSON_malloc)(<span class="keyword">size_t</span> sz) = <span class="built_in">malloc</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">void</span> <span class="params">(*cJSON_free)</span><span class="params">(<span class="keyword">void</span> *ptr)</span> </span>= <span class="built_in">free</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_InitHooks</span><span class="params">(cJSON_Hooks* hooks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hooks) &#123; <span class="comment">/* Reset hooks */</span></span><br><span class="line">        cJSON_malloc = <span class="built_in">malloc</span>;</span><br><span class="line">        cJSON_free = <span class="built_in">free</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cJSON_malloc = (hooks-&gt;malloc_fn)?hooks-&gt;malloc_fn:<span class="built_in">malloc</span>;</span><br><span class="line">    cJSON_free = (hooks-&gt;free_fn)?hooks-&gt;free_fn:<span class="built_in">free</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="节点操作"><a href="#节点操作" class="headerlink" title="节点操作"></a>节点操作</h2><h3 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h3><p>前面定义了数据类型和结构，有了内存管理，下面创建一个新的节点。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* Internal constructor. */</span><br><span class="line">static cJSON *cJSON_New_Item(void)</span><br><span class="line">&#123;</span><br><span class="line">	cJSON* node = (cJSON*)cJSON_malloc(sizeof(cJSON));</span><br><span class="line">	if (node) memset(node,0,sizeof(cJSON));</span><br><span class="line">	return node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>static 定义为静态函数，用 cJSON_malloc 分配内存。然后，在这个节点中创建一些具体的数据。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create basic types: */</span></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateNull</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)item-&gt;type=cJSON_NULL;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateTrue</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)item-&gt;type=cJSON_True;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateFalse</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)item-&gt;type=cJSON_False;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateBool</span><span class="params">(<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)item-&gt;type=b?cJSON_True:cJSON_False;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateNumber</span><span class="params">(<span class="keyword">double</span> num)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)&#123;</span><br><span class="line">        item-&gt;type=cJSON_Number;</span><br><span class="line">        item-&gt;valuedouble=num;item-&gt;valueint=(<span class="keyword">int</span>)num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateString</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)&#123;</span><br><span class="line">        item-&gt;type=cJSON_String;</span><br><span class="line">        item-&gt;valuestring=cJSON_strdup(<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateArray</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)item-&gt;type=cJSON_Array;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateObject</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)item-&gt;type=cJSON_Object;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateIntArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> *numbers,<span class="keyword">int</span> count)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line">cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)</span><br><span class="line">&#123;</span><br><span class="line">n=cJSON_CreateNumber(numbers[i]);</span><br><span class="line"><span class="keyword">if</span>(!i)&#123;</span><br><span class="line">a-&gt;child=n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">suffix_object(p,n);</span><br><span class="line">&#125;</span><br><span class="line">p=n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateFloatArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">float</span> *numbers,<span class="keyword">int</span> count)</span>	</span>&#123;<span class="keyword">int</span> i;cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();<span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)&#123;n=cJSON_CreateNumber(numbers[i]);<span class="keyword">if</span>(!i)a-&gt;child=n;<span class="keyword">else</span> suffix_object(p,n);p=n;&#125;<span class="keyword">return</span> a;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateDoubleArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *numbers,<span class="keyword">int</span> count)</span>	</span>&#123;<span class="keyword">int</span> i;cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();<span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)&#123;n=cJSON_CreateNumber(numbers[i]);<span class="keyword">if</span>(!i)a-&gt;child=n;<span class="keyword">else</span> suffix_object(p,n);p=n;&#125;<span class="keyword">return</span> a;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateStringArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> **strings,<span class="keyword">int</span> count)</span>	</span>&#123;<span class="keyword">int</span> i;cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();<span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)&#123;n=cJSON_CreateString(strings[i]);<span class="keyword">if</span>(!i)a-&gt;child=n;<span class="keyword">else</span> suffix_object(p,n);p=n;&#125;<span class="keyword">return</span> a;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><p>先要删除子节点，然后释放内存。<br>对于 Object，array 删除子节点，在删除自身。<br>对于 string 先要删除字符串部分，然后再删除自己。<br>上面这样做，是因为子节点和string部分都是动态分配的内存，要我们自己去控制。<br>其他类型节点，直接删除节点本身就行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/* Delete a cJSON structure. */</span><br><span class="line">void cJSON_Delete(cJSON *c)</span><br><span class="line">&#123;</span><br><span class="line">	cJSON *next;</span><br><span class="line">	while (c)</span><br><span class="line">	&#123;</span><br><span class="line">		next=c-&gt;next;</span><br><span class="line">		if (!(c-&gt;type&amp;cJSON_IsReference) &amp;&amp; c-&gt;child) cJSON_Delete(c-&gt;child);</span><br><span class="line">		if (!(c-&gt;type&amp;cJSON_IsReference) &amp;&amp; c-&gt;valuestring) cJSON_free(c-&gt;valuestring);</span><br><span class="line">		if (!(c-&gt;type&amp;cJSON_StringIsConst) &amp;&amp; c-&gt;string) cJSON_free(c-&gt;string);</span><br><span class="line">		cJSON_free(c);</span><br><span class="line">		c=next;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h3><p>接着，添加节点只有2种情况，给 object 添加，给 array 添加。<br>给 object 添加的做法只是比 array 多一个 key 值，也就是 string 。那么，可以先给 object 添加 key 之后调用给 array 添加节点的函数来。<br>下面先是写给 array 添加节点的代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_AddItemToArray</span><span class="params">(cJSON *<span class="built_in">array</span>, cJSON *item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cJSON *c = <span class="built_in">array</span>-&gt;child;</span><br><span class="line">	<span class="keyword">if</span> (!item) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (!c) &#123; <span class="comment">// 如果 array 没有子节点，则添加 item</span></span><br><span class="line">		<span class="built_in">array</span>-&gt;child = item;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;                   <span class="comment">// 如果 array 有子节点，子节点之间互为兄弟节点，</span></span><br><span class="line">		<span class="keyword">while</span> (c &amp;&amp; c-&gt;next) <span class="comment">// 所以找最后一个子节点，添加 item ，item 与他们也互为兄弟节点</span></span><br><span class="line">			c = c-&gt;next;</span><br><span class="line">		suffix_object(c, item); <span class="comment">// c，item 是兄弟节点</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外可以有多个子节点，多个子节点之间互为兄弟节点，所以他们有指针互相指向对方，用于遍历该 object/arrary 的所有节点。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">suffix_object</span><span class="params">(cJSON *prev, cJSON *item)</span></span>&#123;</span><br><span class="line">	prev-&gt;next = item;</span><br><span class="line">	item-&gt;next = prev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>给 object 添加节点<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_AddItemToObject</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>, cJSON *item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!item) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (item-&gt;<span class="built_in">string</span>) &#123;           <span class="comment">// 如果 item 有 key，需要释放掉</span></span><br><span class="line">		cJSON_free(item-&gt;<span class="built_in">string</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	item-&gt;<span class="built_in">string</span> = cJSON_strdup(<span class="built_in">string</span>); <span class="comment">// 重新设置 key</span></span><br><span class="line">	cJSON_AddItemToArray(object, item);  <span class="comment">// 添加子节点</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到此，上面对节点的操作都具备了。但是 cJson 中用 define 封装了基本类型的节点添加操作，主要是为了方便。比如添加一个 key 为 null 的节点，正常情况下调用函数如下。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cJSON_AddItemToObject(object,name,cJSON_NULL) <span class="comment">// 第三个参数是 key </span></span><br><span class="line">`</span><br></pre></td></tr></table></figure></p>
<p>封装后就如下。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cJSON_AddNullToObject(object,name)</span><br></pre></td></tr></table></figure></p>
<p>所以封装的部分如下。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Macros for creating things quickly. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddNullToObject(object,name)		cJSON_AddItemToObject(object, name, cJSON_CreateNull())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddTrueToObject(object,name)		cJSON_AddItemToObject(object, name, cJSON_CreateTrue())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddFalseToObject(object,name)		cJSON_AddItemToObject(object, name, cJSON_CreateFalse())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddBoolToObject(object,name,b)	cJSON_AddItemToObject(object, name, cJSON_CreateBool(b))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddNumberToObject(object,name,n)	cJSON_AddItemToObject(object, name, cJSON_CreateNumber(n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddStringToObject(object,name,s)	cJSON_AddItemToObject(object, name, cJSON_CreateString(s))</span></span><br></pre></td></tr></table></figure></p>
<p>并且，还定义了批量创建节点的函数。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateIntArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> *numbers,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateFloatArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">float</span> *numbers,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateDoubleArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *numbers,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateStringArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> **strings,<span class="keyword">int</span> count)</span></span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="未完。"><a href="#未完。" class="headerlink" title="未完。"></a>未完。</h3><p>。。。。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.csdn.net/yzhang6_10/article/details/51615089" target="_blank" rel="noopener">https://blog.csdn.net/yzhang6_10/article/details/51615089</a><br><a href="http://github.tiankonguse.com/blog/2014/12/18/cjson-source.html" target="_blank" rel="noopener">http://github.tiankonguse.com/blog/2014/12/18/cjson-source.html</a><br><a href="https://blog.csdn.net/lintax/article/details/50993958" target="_blank" rel="noopener">https://blog.csdn.net/lintax/article/details/50993958</a><br><a href="https://github.com/faycheng/cJSON" target="_blank" rel="noopener">https://github.com/faycheng/cJSON</a>   </p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/mePic.jpg&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/code/">code</a></div><div class="post-nav"><a class="pre" href="/2020/03/10/CTf-JarvisOJ-100-200/">CTf-JarvisOJ-100-200</a><a class="next" href="/2020/02/22/openwrt-uncompress/">firmware-uncompress</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'o3qEIvAEzJfA0jPzjvyVeUwo-gzGzoHsz',
  appKey:'VBV3VN2vtqwbGqHGFeNL86iw',
  placeholder:'thanks for you read',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://f01965.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE-2018/">CVE / 2018</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志/">日志</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/漏洞利用/" style="font-size: 15px;">漏洞利用</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/固件/" style="font-size: 15px;">固件</a> <a href="/tags/机器学习框架/" style="font-size: 15px;">机器学习框架</a> <a href="/tags/技术分享/" style="font-size: 15px;">技术分享</a> <a href="/tags/CTF-web/" style="font-size: 15px;">CTF-web</a> <a href="/tags/Mircosoft/" style="font-size: 15px;">Mircosoft</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/漏洞分析/" style="font-size: 15px;">漏洞分析</a> <a href="/tags/技术分享-固件/" style="font-size: 15px;">技术分享/固件</a> <a href="/tags/fuzz/" style="font-size: 15px;">fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/02/25/fortigate-Vulnerability/">fortigate Vulnerability</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/23/watchguard/">watchguard</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/18/fortigate/">fortigate</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介3/">spiderMonkey 漏洞利用简介3</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介2/">spiderMonkey 漏洞利用简介2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介/">spiderMonkey 漏洞利用简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/27/X86-ShellCode-2/">X86-ShellCode编写2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/27/X86-ShellCode-1/">X86-ShellCode编写1</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/CVE-2017-17215-拓展/">CVE-2017-17215 拓展</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/25/CVE-2017-17215/">CVE-2017-17215</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://yan-1-20.github.io/about/" title="Asprose" target="_blank">Asprose</a><ul></ul><a href="https://www.lucifaer.com/" title="Lucifaer" target="_blank">Lucifaer</a><ul></ul><a href="http://drac0nids.top/" title="Drac0nids" target="_blank">Drac0nids</a><ul></ul><a href="http://balis0ng.com/" title="balis0ng" target="_blank">balis0ng</a><ul></ul><a href="https://da7uran0ir.github.io/" title="Da7ura_n0ir" target="_blank">Da7ura_n0ir</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"> Dad ， I will always love you.</div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" color="255,0,0" opacity="0.7" zIndex="-1" count="100" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>