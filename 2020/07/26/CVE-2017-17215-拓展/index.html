<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="“一个不像二进制同学的博客。”"><title>CVE-2017-17215 拓展 | f01965</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'true';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
  </script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CVE-2017-17215 拓展</h1><a id="logo" href="/.">f01965</a><p class="description">初闻不知曲中意，再听已是曲中人。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CVE-2017-17215 拓展</h1><div class="post-meta">Jul 26, 2020<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/2020/07/26/CVE-2017-17215-拓展/#vcomment"><span class="valine-comment-count" data-xid="/2020/07/26/CVE-2017-17215-拓展/"></span><span> 条评论</span></a><div class="post-content"><h3><span id="拓展">拓展</span></h3><p>前面已经搞定了环境，执行了exp。<br>现在，用这个搭好的环境来做一点其他事。<br>比如说，劫持一些执行命令的函数：<strong>sytem</strong> ,<strong>execve</strong>，<strong>popen</strong> ，记录它们执行过的参数，存到一个日志文件。<br>方便我们观察，看看有没有可能某些参数来至于我们输入的东西。</p>
<p>所以，首先要做到劫持这些函数。可以自行实现一个so用来做劫持。<br>然后，这个so库预加载起来。比如说写到 <strong>\/etc\/ld.so.preload</strong> 文件中。<br>在来执行web界面程序。就能捕获到web界面上由sytem ,execve，popen执行的参数。</p>
<h4><span id="编写-so">编写 So</span></h4><p>自定义so去实现系统函数的劫持。我打算用 dlsym()。<br>下面以hook system 函数举例。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sysFlag 1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">system</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> (*new_system)(<span class="keyword">const</span> <span class="keyword">char</span> *command);</span><br><span class="line">	<span class="keyword">int</span> result;</span><br><span class="line">    write_log_file(command,sysFlag);        <span class="comment">// 记录参数到日志文件</span></span><br><span class="line">    new_system = dlsym(RTLD_NEXT,<span class="string">"system"</span>);</span><br><span class="line">    result = new_system(command);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>记录参数的函数write_log_file，把日志文件写到 <strong>tmp</strong>目录下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_log_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *data,<span class="keyword">int</span> Flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *log_file = <span class="string">"/tmp/hook.log"</span>;</span><br><span class="line"></span><br><span class="line">    FILE *fp = fopen(log_file, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!fp)</span><br><span class="line">    &#123;</span><br><span class="line">        fp = fopen(log_file, <span class="string">"a"</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        chmod(log_file, <span class="number">0777</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        fclose(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fp = fopen(log_file, <span class="string">"a"</span>);</span><br><span class="line">    <span class="keyword">switch</span>(Flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> sysFlag:<span class="built_in">fprintf</span>(fp, <span class="string">"system  para:%s\n"</span>,data);<span class="keyword">break</span>;</span><br><span class="line">        略...</span><br><span class="line">    &#125;  </span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他函数劫持的写法同上。<br>然后记得用小端mips gcc编译，编译参数：<strong> -fPIC -shared -ldl -D_GNU_SOURCE </strong><br>完整命令： <strong>mips-linux-gcc hook.c -o hook.so -fPIC -shared -ldl -D_GNU_SOURCE</strong><br>这里会有个坑点。放到后面说。<br>编译好后得到 <strong>hook.so</strong></p>
<h4><span id="测试用例-test">测试用例 test</span></h4><p>写好so库，首先来写个测试程序试试。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">"Hello world!n"</span>);</span><br><span class="line">	<span class="keyword">char</span> *arg = <span class="string">"ls -l"</span>;</span><br><span class="line">	system(arg);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样mips gcc 编译：<strong> mips-linux-gcc test.c -o test</strong></p>
<h4><span id="测试">测试</span></h4><p>把hook.so 与 test 都放到搭建好的qemu模拟的虚拟环境下。<br><img src="1.png" alt=""><br>ps：我这里名字叫hook2.so</p>
<p>因为我们是要劫持路由器Web服务的函数，所以开启web服务时就要让它加载上hook.so。这是成功的关键。<br>前面说，把hook.so路径写入到<strong>\/etc/ld.so.preload</strong>，就能实现预加载。查查资料就会知道这个 ld.so.preload是干什么用的。<br>它其实将想要预加载so库，加载到后续所有要执行的文件。用 ldd 命令可以查看。</p>
<p>初次执行<strong>ldd test</strong>，如下图。<br><img src="2.png" alt=""></p>
<p>只有一个 libc.so.0 \= > not found<br>而且 ./test 执行不了，因为缺主要的so依赖。在 <strong>squashfs-root\/lib\/</strong>下有需要的so：libc.so.0 ，ld-uClibc.so.0，ld-uClibc-0.9.30.so ， libuClibc-0.9.30.so<br>这几个统统拷贝到qemu下的 <strong>lib</strong> 目录下。<br><strong>cp squashfs-root\lib\libc.so.0  /lib/</strong><br>…</p>
<p>再次执行<strong>ldd test</strong>，如下。<br><img src="3.png" alt=""></p>
<h4><span id="ldsopreload">ld.so.preload</span></h4><p>这个时候来编辑<strong>/etc/ld.so.preload</strong> ，先看看这个文件存在不存在。<br><strong>cat /etc/ld.so.preload</strong><br>存在不存在其实都无所谓。<br>接着把 hook.so 绝对路径写进去。这里先提前把 hook.so 放到 <strong>tmp</strong>目录下，因为输出的日志文件也是<strong>tmp</strong>下的。<br>那么，用命令：<strong>echo /tmp/hook.so &gt; /etc/ld.so.preload </strong>，如下图。<br><img src="4.png" alt=""></p>
<p>再来执行<strong>ldd test</strong>，如下。<br><img src="5.png" alt=""></p>
<p>看到多了一个 <strong>/tmp/hook.so (0x2aaab000)</strong>，说明ld.so.preload有用。</p>
<h4><span id="dlsym">dlsym</span></h4><p>接着，运行一下test。<br><img src="6.png" alt=""></p>
<p>有个错误，说不认识 <strong>dlsym</strong> 。这个函数呢，实际上是在<strong>squashfs-root/lib/</strong>下的<strong>libdl.so.0</strong>里面。<br>所以呀，我们把<strong>libdl.so.0</strong>拷贝到 <strong>tmp</strong>下。 然后也写入<strong>ld.so.preload</strong>中。<br><strong>echo /tmp/libdl.so.0:/tmp/hook.so &gt;  ./etc/ld.so.preload</strong></p>
<p><strong>再次提醒，我们前面的操作，到目前为止都是在 qemu 本身模拟的环境，没用chroot 切换到路由器目录，所以还没有对路由器进行测试</strong></p>
<p>再来 <strong>ldd test</strong>，会发现出错，但是没关系。我们执行一下 <strong>./test </strong>，如果 <strong>tmp 下创建了 hook.log 说明我们的hook.so成功了</strong>。<br>如下图。<br><img src="7.png" alt=""></p>
<p>也能看到 hook.log 文件里确实记录了参数。为了保险起见，再确认一些 ld.so.preload 确实起作用了。<br>那么，把ld.so.preload清空：<strong>echo “” &gt; /etc/ld.so.preload</strong><br>删除hook.log：<strong>rm -f hook.log</strong>，再次运行test。如下。<br><img src="8.png" alt=""></p>
<p>没有创建 <strong>hook.log</strong> ，再次说明ld.so.preload设置有用。</p>
<h5><span id="chroot-squashfs-root-sh">Chroot squashfs-root sh</span></h5><p>前面在qemu模拟的mips下说明ld.so.preload有效。那么，chroot切换到路由器来试试。<br><strong>Chroot squashfs-root sh </strong><br>把test ，hook.so 复制到 squashfs-root/tmp/ ，如下。<br><img src="9.png" alt=""></p>
<p>可以看到，我还另外放了一个<strong>busybox-mips</strong> ，因为路由器文件系统的busybox支持的命令太少。<br>ldd命令用不了。所以，直接运行test看，然后以有没有hook.log生成来判断这个文件系统中 ld.so.preload 是否有用。<br><img src="10.png" alt=""></p>
<p>执行成功，但是没有hook.log。</p>
<p>那么，设置 ld.so.preload，如下。<br><img src="11.png" alt=""></p>
<p>可以看到，虽然设置了 ld.so.preload，test也成功运行了。但是，并没有hook.log 文件。说明，这样设置的ld.so.preload，不会起作用。<br>那么，用 <strong>export LD_PRELOAD=/tmp/hook.so</strong> 试试<br><img src="12.png" alt=""></p>
<p>从图上看，ld.so.preload清空，然后运行test报一个dlsym错误，说明export这样设置成功了。那把libc.so.0也export。<br><strong>export LD_PRELOAD=/tmp/hook.so:/lib/libdl.so.0</strong><br><img src="13.png" alt=""></p>
<p>成功了。</p>
<p>这说明一个问题，也就是用chroot切换到路由器文件系统中，设置 ld.so.preload 不会起作用。至少是对这个测试来看。用export LD_PRELOAD 是有效的。</p>
<p>那我们用 export也设置一下，然后用当前设置的终端执行: <strong>./bin/upnp  ./bin/mic</strong><br>你会发现执行起来的web服务中会带上hook.log。</p>
<h4><span id="exp-测试">Exp 测试</span></h4><p>用CVE2017-17215的exp测试一下，能看到我写的So库抓到了system执行的命令。<br><img src="14.png" alt=""></p>
<h4><span id="坑点">坑点</span></h4><p>前面编译的时候说到有坑，就是在用Mips gcc编译，命令是：<strong>mips-linux-gcc hook.c -o hook.so -fPIC -shared -ldl -D_GNU_SOURCE</strong><br>这个命令中，参数 <strong>ldl</strong> 可以有，也可以没有，都能编译通过。<br>但是编译出来的 hook.so 中，用IDA查看，程序启动没有加载 libc.so.0。我是很纳闷的，有知道的师傅可以告诉一下。<br>如下图。<br><img src="17.png" alt=""></p>
<p>但是，但是，用 Linux gcc 编译的话，有<strong>ldl</strong>，就会带上libc.so.0。如下图。<br><img src="18.png" alt=""><br>图上是libc.so.6，因为我linux版本比较高。</p>
<p>若没有 <strong>ldl</strong> 就不会带上libc.so.6。</p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/mePic.jpg&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/漏洞利用/">漏洞利用</a><a href="/tags/固件/">固件</a></div><div class="post-nav"><a class="pre" href="/2020/07/27/X86-ShellCode-1/">X86-ShellCode编写1</a><a class="next" href="/2020/07/25/CVE-2017-17215/">CVE-2017-17215</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'o3qEIvAEzJfA0jPzjvyVeUwo-gzGzoHsz',
  appKey:'VBV3VN2vtqwbGqHGFeNL86iw',
  placeholder:'thanks for you read',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://f01965.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE-2018/">CVE / 2018</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志/">日志</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/漏洞利用/" style="font-size: 15px;">漏洞利用</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/固件/" style="font-size: 15px;">固件</a> <a href="/tags/机器学习框架/" style="font-size: 15px;">机器学习框架</a> <a href="/tags/技术分享/" style="font-size: 15px;">技术分享</a> <a href="/tags/CTF-web/" style="font-size: 15px;">CTF-web</a> <a href="/tags/Mircosoft/" style="font-size: 15px;">Mircosoft</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/漏洞分析/" style="font-size: 15px;">漏洞分析</a> <a href="/tags/技术分享-固件/" style="font-size: 15px;">技术分享/固件</a> <a href="/tags/fuzz/" style="font-size: 15px;">fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/04/10/CVE-2018-5146/">CVE-2018-5146</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/02/24/2021总结/">2021总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/25/fortigate-Vulnerability/">fortigate Vulnerability</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/23/watchguard/">watchguard</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/18/fortigate/">fortigate</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介3/">spiderMonkey 漏洞利用简介3</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介2/">spiderMonkey 漏洞利用简介2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介/">spiderMonkey 漏洞利用简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/07/winAFL实践/">winAFL实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/27/X86-ShellCode-2/">X86-ShellCode编写2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://yan-1-20.github.io/about/" title="Asprose" target="_blank">Asprose</a><ul></ul><a href="https://www.lucifaer.com/" title="Lucifaer" target="_blank">Lucifaer</a><ul></ul><a href="http://drac0nids.top/" title="Drac0nids" target="_blank">Drac0nids</a><ul></ul><a href="http://balis0ng.com/" title="balis0ng" target="_blank">balis0ng</a><ul></ul><a href="https://da7uran0ir.github.io/" title="Da7ura_n0ir" target="_blank">Da7ura_n0ir</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"> Dad ， I will always love you.</div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" color="255,0,0" opacity="0.7" zIndex="-1" count="100" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>