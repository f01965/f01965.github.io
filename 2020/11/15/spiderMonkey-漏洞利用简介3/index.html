<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="“一个不像二进制同学的博客。”"><title>spiderMonkey 漏洞利用简介3 | f01965</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'true';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
  </script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">spiderMonkey 漏洞利用简介3</h1><a id="logo" href="/.">f01965</a><p class="description">初闻不知曲中意，再听已是曲中人。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">spiderMonkey 漏洞利用简介3</h1><div class="post-meta">Nov 15, 2020<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/2020/11/15/spiderMonkey-漏洞利用简介3/#vcomment"><span class="valine-comment-count" data-xid="/2020/11/15/spiderMonkey-漏洞利用简介3/"></span><span> 条评论</span></a><div class="post-content"><p>注：这是接着前两篇文章的第三部分。由于原文实在是有点长，我根据文章的内容分了一下。<br>原文：<a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/#jsvalues-and-jsobjects" target="_blank" rel="noopener">https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/#jsvalues-and-jsobjects</a></p>
<h2 id="ifrit-js"><a href="#ifrit-js" class="headerlink" title="ifrit.js"></a>ifrit.js</h2><p>这个漏洞利用的很大一部分是 <a href="https://github.com/0vercl0k/blazefox/blob/master/exploits/byop.js#L2" title="Bring Your Own Payload" target="_blank" rel="noopener">Bring Your Own Payload</a> 部分。这看起来很简单，但结果却比我想象的要麻烦得多。如果我们把它拉下来看，我们的利用应该与 kaizen.js 几乎相同，因为劫持控制流将是最后一步。</p>
<h3 id="在Windows上编译64位版本的Firefox"><a href="#在Windows上编译64位版本的Firefox" class="headerlink" title="在Windows上编译64位版本的Firefox"></a>在Windows上编译64位版本的Firefox</h3><p>在回到调试之前，我们需要实际编译一个我们可以使用的 Firefox 版本。这很简单，我没有对这部分做大量的记录，这说明编译时一切都很顺利（只是不要忘记应用 blaze.patch 来获取易受攻击的 xul.dll 模块）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp browser/config/mozconfigs/win64/plain-opt mozconfig</span><br><span class="line">$ mach build</span><br></pre></td></tr></table></figure></p>
<p>如果您不想构建 Firefox，我已经上传了 7z 档案，其中包含我为 Windows 64 位构建的二进制文件以及 xul.dll 的私有符号：<a href="https://github.com/0vercl0k/blazefox/blob/master/ff-bin.7z.001" title="ff-bin.7z.001 " target="_blank" rel="noopener">ff-bin.7z.001 </a>和 <a href="https://github.com/0vercl0k/blazefox/blob/master/ff-bin.7z.002" title="ff-bin。7z.002" target="_blank" rel="noopener">ff-bin。7z.002</a>。</p>
<h3 id="配置Firefox以开发ifrit"><a href="#配置Firefox以开发ifrit" class="headerlink" title="配置Firefox以开发ifrit"></a>配置Firefox以开发ifrit</h3><p>为了简化操作，我们可以打开/关闭一系列设置，让我们的操作更轻松一下（在 about：config 中）：</p>
<ol>
<li>禁用沙箱：security.sandbox.content.level = 0，</li>
<li>禁用多进程模式：browser.tabs.remote.autostart = false，</li>
<li>从崩溃中禁用简历：browser.sessionstore.resume_from_crash = false，</li>
<li>禁用默认浏览器检查：browser.shell.checkDefaultBrowser = false。</li>
</ol>
<p>要调试特定的内容过程（启用多进程模式），您可以通过鼠标到选项卡，它应该告诉您其 PID 如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190822165041-ebe6dc8c-c4b9-1.png" alt="image.png"></p>
<p>使用这些设置，附加到处理内容的 Firefox 进程应该是很容易的。</p>
<h3 id="强制JIT编译payload：Bring-Your-Own-Payload"><a href="#强制JIT编译payload：Bring-Your-Own-Payload" class="headerlink" title="强制JIT编译payload：Bring Your Own Payload"></a>强制JIT编译payload：Bring Your Own Payload</h3><p>首先要查看一下我们的 payload 。正如我们之前看到的，我们知道如果我们希望它走分支到下一个常量，我们可以仅使用八个字节中的六个字节。说实话，六个字节够用了，但同时常规编译器生成的一堆更大指令。正如你在下面看到的，有一些（虽然也不是很多）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">000001c1`1b226411 488d056b020000  lea     rax,[000001c1`1b226683]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b226421 488d056b020000  lea     rax,[000001c1`1b226693]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b22643e 488d153e020000  lea     rdx,[000001c1`1b226683]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b2264fb 418b842488000000 mov     eax,dword ptr [r12+88h]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b22660e 488da42478ffffff lea     rsp,[rsp-88h]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b226616 488dbd78ffffff  lea     rdi,[rbp-88h]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b226624 c78578ffffff68000000 mov dword ptr [rbp-88h],68h</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b226638 4c8d9578ffffff  lea     r10,[rbp-88h]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b22665b 488d0521000000  lea     rax,[000001c1`1b226683]</span><br><span class="line">[...]</span><br><span class="line">000001c1`1b226672 488d150a000000  lea     rdx,[000001c1`1b226683]</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<p>过了一会儿，我终于意识到 SCC 生成的  payload ，是假定它将运行的位置是可写的和可执行的。如果在堆栈上或在TypedArray 的后备缓冲区中运行它，它可以正常工作：就像是在 basic 和 kaizen 中（译者注：前面文章中的basic.js / /kaizen.js ）。但是，从 JIT 页面来看，它没有，并且它成为一个问题，因为出于安全原因，这里是没有写权限的。所以我放弃了之前的 payload 开始自己构建一个新的。我用C语言编写它，使其与一些方便的脚本无关<br>这是我的队友 <a href="https://twitter.com/yrp604" title="yrp" target="_blank" rel="noopener">yrp</a> 与我分享的。经过匆忙的编译和各种选项后，我最终得到的东西大小合适，而且好像是有用的。<br>在回来观察这个 payload ，情况看起来非常类似于上面：大于六个字节的指令最终为少数。幸好。 在这一点上，是时候离开 C 搬到汇编代码去看看。我解压缩了程序集并开始用较小的语义等效指令手动替换所有这些指令。这是一个不难但却很烦人的问题。 如果您想要查看它，这里 <a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/payload/payload/payload.asm" title="assembly payload" target="_blank" rel="noopener">assembly payload</a>。</p>
<p>最终，payload 正常工作，但这次没有大于六个字节的指令。我们可以开始编写 JavaScript 代码来迭代 assembly payload ，并在常量中包含尽可能多的指令。你可以在同一个常量中打包 3 个 2 字节的指令，但不要是 4 个字节或 3字节的。<br>在尝试了生成的 payload 之后，我发现两个主要问题：</p>
<ul>
<li>在每个指令之间使用“填充”会破坏 x64 代码中的每种类型的引用。rip 寻址被破坏，间接跳转和间接调用都被损坏。</li>
<li>用大量常量生成 JITing 函数会生成更大的指令。在前面的例子中，我们基本上重复了以下模式：一个 8 字节的 mov r11，常量后跟一个四字节的 mov qword ptr [rbp-offset]，r11 。好吧，如果你的 JavaScript 函数开始有很多常量，那么最终偏移量会变大（因为所有 doubles 型数据都存储在堆栈帧中），而且 mov qword ptr [rbp-offset]， r11 指令现在以七个字节编码。更恼火的是我们在整个 JITed payload 中混合使用了这两种编码。这对我们的 payload 来说是一个可怕的事，因为我们不知道要向前跳多少字节。如果我们跳得太远或者不够远，我们冒险尝试执行可能会导致我们崩溃在某些指令中间。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">000000bf`c2ed9b88 49bb909090909090eb09 mov r11,9EB909090909090h</span><br><span class="line">000000bf`c2ed9b92 4c895db0        mov     qword ptr [rbp-50h],r11 &lt;- small</span><br><span class="line"></span><br><span class="line">VS</span><br><span class="line"></span><br><span class="line">000000bf`c2ed9bc9 49bb909090909090eb09 mov r11,9EB909090909090h</span><br><span class="line">000000bf`c2ed9bd3 4c899db8f5ffff  mov     qword ptr [rbp-0A48h],r11 &lt;- big</span><br></pre></td></tr></table></figure>
<p>我开始尝试解决第二个问题。我想如果我对这个问题没有满意的答案，我就无法在 payload 中正确修复引用。老实说，此时我有点倦怠，它真的值得吗？ 可能并不是。所以我决定稍作休息一段时间后再回来。经过一段小小的休息后，在观察 baseline JIT 的行为后，我注意到如果我在这个函数中有更多的常量，我可以或多或少地间接控制偏移的大小。如果我将它变得足够大，七个字节就足以编码非常大的偏移量。所以我开始注入一堆无用的常量来扩大堆栈框架并使偏移量不断增长。 最终，一旦这个偏移“饱和”，我们就会得到一个很好的稳定布局，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; u 00000123`c34d67c1 l100</span><br><span class="line">00000123`c34d67c1 49bb909090909090eb09 mov r11,9EB909090909090h</span><br><span class="line">00000123`c34d67cb 4c899db0feffff  mov     qword ptr [rbp-150h],r11</span><br><span class="line">00000123`c34d67d2 49bb909090909050eb09 mov r11,9EB509090909090h</span><br><span class="line">00000123`c34d67dc 4c899db0ebffff  mov     qword ptr [rbp-1450h],r11</span><br><span class="line">00000123`c34d67e3 49bb909090909053eb09 mov r11,9EB539090909090h</span><br><span class="line">00000123`c34d67ed 4c899d00faffff  mov     qword ptr [rbp-600h],r11</span><br><span class="line">00000123`c34d67f4 49bb909090909051eb09 mov r11,9EB519090909090h</span><br><span class="line">00000123`c34d67fe 4c899d98fcffff  mov     qword ptr [rbp-368h],r11</span><br><span class="line">00000123`c34d6805 49bb909090909052eb09 mov r11,9EB529090909090h</span><br><span class="line">00000123`c34d680f 4c899d28ffffff  mov     qword ptr [rbp-0D8h],r11</span><br><span class="line">00000123`c34d6816 49bb909090909055eb09 mov r11,9EB559090909090h</span><br><span class="line">00000123`c34d6820 4c899d00ebffff  mov     qword ptr [rbp-1500h],r11</span><br><span class="line">00000123`c34d6827 49bb909090909056eb09 mov r11,9EB569090909090h</span><br><span class="line">00000123`c34d6831 4c899db0edffff  mov     qword ptr [rbp-1250h],r11</span><br><span class="line">00000123`c34d6838 49bb909090909057eb09 mov r11,9EB579090909090h</span><br><span class="line">00000123`c34d6842 4c899d30f6ffff  mov     qword ptr [rbp-9D0h],r11</span><br><span class="line">00000123`c34d6849 49bb909090904150eb09 mov r11,9EB504190909090h</span><br><span class="line">00000123`c34d6853 4c899d90f2ffff  mov     qword ptr [rbp-0D70h],r11</span><br><span class="line">00000123`c34d685a 49bb909090904151eb09 mov r11,9EB514190909090h</span><br><span class="line">00000123`c34d6864 4c899dd8f8ffff  mov     qword ptr [rbp-728h],r11</span><br><span class="line">00000123`c34d686b 49bb909090904152eb09 mov r11,9EB524190909090h</span><br><span class="line">00000123`c34d6875 4c899dc0f7ffff  mov     qword ptr [rbp-840h],r11</span><br><span class="line">00000123`c34d687c 49bb909090904153eb09 mov r11,9EB534190909090h</span><br><span class="line">00000123`c34d6886 4c899db0fbffff  mov     qword ptr [rbp-450h],r11</span><br><span class="line">00000123`c34d688d 49bb909090904154eb09 mov r11,9EB544190909090h</span><br><span class="line">00000123`c34d6897 4c899d48eeffff  mov     qword ptr [rbp-11B8h],r11</span><br><span class="line">00000123`c34d689e 49bb909090904155eb09 mov r11,9EB554190909090h</span><br><span class="line">00000123`c34d68a8 4c899d68fbffff  mov     qword ptr [rbp-498h],r11</span><br><span class="line">00000123`c34d68af 49bb909090904156eb09 mov r11,9EB564190909090h</span><br><span class="line">00000123`c34d68b9 4c899d48f4ffff  mov     qword ptr [rbp-0BB8h],r11</span><br><span class="line">00000123`c34d68c0 49bb909090904157eb09 mov r11,9EB574190909090h</span><br><span class="line">00000123`c34d68ca 4c895da0        mov     qword ptr [rbp-60h],r11 &lt;- NOOOOOO</span><br><span class="line">00000123`c34d68ce 49bb9090904989e3eb09 mov r11,9EBE38949909090h</span><br><span class="line">00000123`c34d68d8 4c899d08eeffff  mov     qword ptr [rbp-11F8h],r11</span><br></pre></td></tr></table></figure>
<p>好吧，接近完美。 虽然我尝试了很多东西，但我也不认为我已经完成了一个完全干净的布局（最后附加大约七十个 doubles ）。我也不知道原因，因为这只是基于观察。 但是如果你考虑一下，我们：不使用 rip 寻址，我们可以允许一些“错误”，我们可以在指令之前使用 NOP 滑板来“容忍”一些错误。<br>对于问题的第一部分，我基本上在每条指令之间注入了许多 NOP 指令。我以为我会把它扔进 <a href="https://docs.microsoft.com/en-us/cpp/assembler/masm/masm-for-x64-ml64-exe?view=vs-2017" title="ml64.exe" target="_blank" rel="noopener">ml64.exe</a>，让它为我找出参考资料。不幸的是，有一些问题让我摆脱了这个解决方案。 以下是我能记住的一些问题：</p>
<ul>
<li>由于您必须准确知道要注入的 NOP 数量以模拟“ JIT 环境”，您还需要知道要植入的指令的大小。问题在于，当您在每条指令之间使用 NOP 对 payload 进行填充时，某些指令的编码方式会有所不同。想象一下在两个字节上编码的短跳转……好吧它可能变成用四个字节编码的长跳转。 如果这发生了，它会弄乱一切。</li>
</ul>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190822173142-a6d8c1ea-c4bf-1.png" alt="image.png"></p>
<ul>
<li>作为上述观点的后续行为，我想我会尝试强制 MASM64 一直生成长跳转，而不是短跳转。 事实证明，我没有办法做到避免这个麻烦事。</li>
<li>我的初始工作流程是：我将使用 WinDbg dump 程序集，将其发送到 Python 脚本，该脚本生成一个我将使用 ml64 编译的 .asm 需要记住的是，在 x86 中，一条指令可以有多种不同的编码。 有不同的尺寸。所以再一次，我遇到了与上面相同类问题的问题： ml64 会对反汇编指令进行一些不同的编码和 kaboom 。</li>
</ul>
<p>最后，我自己实施它来。 我有一个 Python 脚本，可以在几个通道中工作。 脚本的输入只是我想要 JITify 的 payload 的 WinDbg 反汇编。 每行都有指令的地址，编码的字节和反汇编代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = &apos;&apos;&apos;00007ff6`6ede1021 50              push    rax</span><br><span class="line">00007ff6`6ede1022 53              push    rbx</span><br><span class="line">00007ff6`6ede1023 51              push    rcx</span><br><span class="line">00007ff6`6ede1024 52              push    rdx</span><br><span class="line"># [...]</span><br><span class="line">&apos;&apos;&apos;</span><br></pre></td></tr></table></figure>
<p>让我们来看看 <a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/payload2jit.py" title="payload2jit.py" target="_blank" rel="noopener">payload2jit.py</a> ：</p>
<ul>
<li>第一步是规范化 payload 的文本版本。显然，我们不想处理文本，因此我们提取地址（对标签化很有用），编码（计算要注入的 NOP 的数量）和反汇编（用于重新组装）。 这里有一个示例输出 <a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/_p0.asm" title="\_p0.asm" target="_blank" rel="noopener">_p0.asm</a>。</li>
<li>第二步是我们的 payload 的标签化。我们遍历每一行，我们用标签替换绝对地址。这是必需的，以便我们可以让 <a href="http://www.keystone-engine.org/" title="keystone" target="_blank" rel="noopener">keystone</a> 重新组装 payload 并在以后处理引用。 <a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/_p1.asm" title="\_p1.asm" target="_blank" rel="noopener">_p1.asm</a> 中提供了一个示例输出。</li>
<li><p>在这个阶段，我们进入迭代过程。 它的目标是组装 payload 并将其与上一次迭代进行比较。如果我们发现同一指令的编码之间存在差异，我们必须重新调整注入的 NOP 数量。如果编码较大，我们删除 NOP ; 如果它更小，我们添加 NOP 。 我们重复这个阶段，直到组装的 payload 收敛到没有变化。需要迭代2次才能达到 payload 的稳定性：<a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/_p2.asm" title="\_p2.asm" target="_blank" rel="noopener">_p2.asm</a> / <a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/_p2.bin" title="\_p2.bin" target="_blank" rel="noopener">_p2.bin</a> 和 <a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/_p3.asm" title="\_p3.asm" target="_blank" rel="noopener">_p3.asm</a> / <a href="https://github.com/0vercl0k/blazefox/blob/master/scripts/_p3.bin" title="\_p3.bin" target="_blank" rel="noopener">_p3.bin</a>。</p>
</li>
<li><p>一旦我们有一个汇编的 payload，我们生成一个 JavaScript 文件并调用一个解释器让它生成一个 byop.js 文件，该文件中包含编码我们最终 payload 的常量。</p>
</li>
</ul>
<p>这是脚本在 stdout 上产生的内容（一些短跳转指令需要更大的编码，因为 payload 会膨胀）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(C:\ProgramData\Anaconda2) c:\work\codes\blazefox\scripts&gt;python payload2jit.py</span><br><span class="line">[+] Extracted the original payload, 434 bytes (see _p0.asm)</span><br><span class="line">[+] Replaced absolute references by labels (see _p1.asm)</span><br><span class="line">[+] #1 Assembled payload, 2513 bytes, 2200 instructions (_p2.asm/.bin)</span><br><span class="line">  &gt; je 0x3b1 has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; je 0x3b1 has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; je 0x53b has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; jne 0x273 has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; je 0x3f7 has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; je 0x3f7 has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; je 0x3f7 has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; je 0x816 has been encoded with a larger size instr 2 VS 6</span><br><span class="line">  &gt; jb 0x6be has been encoded with a larger size instr 2 VS 6</span><br><span class="line">[+] #2 Assembled payload, 2477 bytes, 2164 instructions (_p3.asm/.bin)</span><br><span class="line">[*] Generating bring_your_own_payload.js..</span><br><span class="line">[*] Spawning js.exe..</span><br><span class="line">[*] Outputting byop.js..</span><br></pre></td></tr></table></figure>
<p>最后，经过大量操作，hacky-scripts，无数个小时的调试和相当多的挫折……我们等待的那一刻\ o /：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190822174502-834c8c1e-c4c1-1.gif" alt=""></p>
<h3 id="评估"><a href="#评估" class="headerlink" title="评估"></a>评估</h3><p>事实证明这个漏洞比我预想的更麻烦。 最后结果很好，因为我们只需要劫持控制流，我们可以获得任意的代码执行，而不需要 ROP 。 现在，还有很多我想调查的事情（其中一些我可能会很快）：</p>
<ul>
<li>实际构建一个实际有用的 payload 会很酷。 在每个选项卡中注入任意 JavaScript，或启用某种 UXSS 条件的东西。 我们甚至可以通过几个关键结构的修改来解决这个问题（当时在 Internet Explorer 中使用 GodMode / SafeMode）。</li>
<li>在各种版本的 Firefox 上实际测试这个 BYOP，看看它是否真的可靠（并量化它）也会很有趣。 如果它是那么我会好奇测试它的限制：更大的 payload，更好的工具，用于将任意  payload “转换”为 JITable 等等。</li>
<li>另一个有趣的途径是评估在不劫持间接调用的情况下获取代码执行是多么麻烦（假设 Firefox 启用某种软件 CFI 解决方案）。</li>
<li>我也确信在 baseline JIT 和 IonMonkey 中都有很多有趣的技巧可以帮助开发技术，原语和实用程序。</li>
<li>WebAssembly 和 JIT 应该可以开辟其他有趣的利用途径。 这很有趣，因为在写完文章的时候，我刚刚注意到 <a href="https://twitter.com/rh0_gz" title="@ rh0_gz" target="_blank" rel="noopener">@ rh0_gz</a> 的酷工作似乎已经使用 WASM JIT 开发了一种非常相似的技术，请查看： <a href="https://rh0dev.github.io/blog/2018/more-on-asm-dot-js-payloads-and-exploitation/" title="More on ASM.JS Payloads and Exploitation" target="_blank" rel="noopener">More on ASM.JS Payloads and Exploitation</a></li>
<li>我想尝试的最后一件事是使用<a href="https://github.com/theori-io/pwnjs" title=" pwn.js" target="_blank" rel="noopener"> pwn.js</a></li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>这一路看来，希望你没有睡着:)。 感谢阅读，希望你们都喜欢骑行并学到了一两件事。<br>如果您想在家里玩并重新创建我上面描述的内容，我上传了<a href="https://github.com/0vercl0k/blazefox" title=" blazefox GitHub" target="_blank" rel="noopener"> blazefox GitHub</a> 存储库中所需的所有内容，如上所述。 没有理由不在家玩:)。<br>我很想听到反馈/想法，所以请随时在推特上点击 <a href="https://twitter.com/0vercl0k" title="@ 0vercl0k" target="_blank" rel="noopener">@ 0vercl0k</a> ，或者在 IRC 上找我。</p>
<p>最后但同样重要的是，我要感谢我的伙伴 <a href="https://twitter.com/yrp604" title="yrp604" target="_blank" rel="noopener">yrp604</a> 和 <a href="https://twitter.com/__x86" title="\_\_x86" target="_blank" rel="noopener">__x86</a> 进行校对，编辑和所有反馈:)。</p>
<p>一堆有用且不太有用的链接（我已粘贴在上面的一些链接）：</p>
<p>-<a href="https://phoenhex.re/2017-06-21/firefox-structuredclone-refleak" title=" Share with care: Exploiting a Firefox UAF with shared array buffers" target="_blank" rel="noopener"> Share with care: Exploiting a Firefox UAF with shared array buffers</a></p>
<ul>
<li><a href="https://grehack.fr/data/2017/slides/GreHack17_Get_the_Spidermonkey_off_your_back.pdf" title="Get the (Spider)monkey off your back" target="_blank" rel="noopener">Get the (Spider)monkey off your back</a></li>
<li><a href="https://saelo.github.io/posts/firefox-script-loader-overflow.html" title="Exploiting a Cross-mmap Overflow in Firefox" target="_blank" rel="noopener">Exploiting a Cross-mmap Overflow in Firefox</a></li>
<li><a href="http://blogs.360.cn/blog/how-to-kill-a-firefox-en/" title="How to kill a (Fire)fox" target="_blank" rel="noopener">How to kill a (Fire)fox</a></li>
<li><a href="https://media.blackhat.com/bh-us-11/Rohlf/BH_US_11_RohlfIvnitskiy_Attacking_Client_Side_JIT_Compilers_Slides.pdf" title="Attacking Client Side JIT Compilers" target="_blank" rel="noopener">Attacking Client Side JIT Compilers</a></li>
<li><a href="https://www.portokalidis.net/files/devilinconstants_ndss15.pdf" title="The Devil is in the Constants: Bypassing Defenses in Browser JIT Engines" target="_blank" rel="noopener">The Devil is in the Constants: Bypassing Defenses in Browser JIT Engines</a></li>
<li><a href="https://rh0dev.github.io/blog/2017/the-return-of-the-jit/" title="The Return of the JIT (Part 1)" target="_blank" rel="noopener">The Return of the JIT (Part 1)</a></li>
<li><a href="https://rh0dev.github.io/blog/2017/the-return-of-the-jit-part-2/" title="The Return of the JIT (Part 2)" target="_blank" rel="noopener">The Return of the JIT (Part 2)</a></li>
<li><a href="https://mathiasbynens.be/notes/shapes-ics" title="JavaScript engine fundamentals: Shapes and Inline Caches" target="_blank" rel="noopener">JavaScript engine fundamentals: Shapes and Inline Caches</a></li>
<li><a href="https://wiki.mozilla.org/JavaScript:New_to_SpiderMonkey" title="JavaScript:New to SpiderMonkey" target="_blank" rel="noopener">JavaScript:New to SpiderMonkey</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey" title="SpiderMonkey docs" target="_blank" rel="noopener">SpiderMonkey docs</a></li>
<li>~old <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Internals" title="Spidermonkey Internals" target="_blank" rel="noopener">Spidermonkey Internals</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/JSAPI_User_Guide" title="JSAPI" target="_blank" rel="noopener">JSAPI</a></li>
<li><a href="https://archive.mozilla.org/pub/firefox/nightly/latest-mozilla-central/" title="JS shell binary for win64" target="_blank" rel="noopener">JS shell binary for win64</a></li>
<li><a href="https://dxr.mozilla.org/mozilla-central/source/js/src/shell/js.cpp#6746" title="shell_functions" target="_blank" rel="noopener">shell_functions</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/GC_Rooting_Guide" title="Rooting guide" target="_blank" rel="noopener">Rooting guide</a></li>
<li><a href="https://wiki.mozilla.org/IonMonkey/Overview" title="IonMonkey JIT" target="_blank" rel="noopener">IonMonkey JIT</a></li>
<li>Sympath: srv<em>c:\symbols</em><a href="https://symbols.mozilla.org/" target="_blank" rel="noopener">https://symbols.mozilla.org/</a></li>
<li><a href="http://www.aosabook.org/en/posa/memshrink.html" title="The Performance Of Open Source Software: MemShrink" target="_blank" rel="noopener">The Performance Of Open Source Software: MemShrink</a></li>
<li><a href="http://phrack.org/issues/69/14.html" title="OR&#39;LYEH? The Shadow over Firefox" target="_blank" rel="noopener">OR’LYEH? The Shadow over Firefox</a></li>
<li><a href="https://infiltratecon.com/archives/the_shadow_over_firefox_infiltrate_2015.pdf" title="The Shadow over Firefox" target="_blank" rel="noopener">The Shadow over Firefox</a></li>
</ul>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/mePic.jpg&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/漏洞利用/">漏洞利用</a></div><div class="post-nav"><a class="pre" href="/2021/02/18/fortigate/">fortigate</a><a class="next" href="/2020/11/15/spiderMonkey-漏洞利用简介2/">spiderMonkey 漏洞利用简介2</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'o3qEIvAEzJfA0jPzjvyVeUwo-gzGzoHsz',
  appKey:'VBV3VN2vtqwbGqHGFeNL86iw',
  placeholder:'thanks for you read',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://f01965.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CVE-2018/">CVE / 2018</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志/">日志</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/漏洞利用/" style="font-size: 15px;">漏洞利用</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/固件/" style="font-size: 15px;">固件</a> <a href="/tags/机器学习框架/" style="font-size: 15px;">机器学习框架</a> <a href="/tags/技术分享/" style="font-size: 15px;">技术分享</a> <a href="/tags/CTF-web/" style="font-size: 15px;">CTF-web</a> <a href="/tags/Mircosoft/" style="font-size: 15px;">Mircosoft</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/漏洞分析/" style="font-size: 15px;">漏洞分析</a> <a href="/tags/技术分享-固件/" style="font-size: 15px;">技术分享/固件</a> <a href="/tags/fuzz/" style="font-size: 15px;">fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/02/25/fortigate-Vulnerability/">fortigate Vulnerability</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/23/watchguard/">watchguard</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/18/fortigate/">fortigate</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介3/">spiderMonkey 漏洞利用简介3</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介2/">spiderMonkey 漏洞利用简介2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/spiderMonkey-漏洞利用简介/">spiderMonkey 漏洞利用简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/27/X86-ShellCode-2/">X86-ShellCode编写2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/27/X86-ShellCode-1/">X86-ShellCode编写1</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/CVE-2017-17215-拓展/">CVE-2017-17215 拓展</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/25/CVE-2017-17215/">CVE-2017-17215</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://yan-1-20.github.io/about/" title="Asprose" target="_blank">Asprose</a><ul></ul><a href="https://www.lucifaer.com/" title="Lucifaer" target="_blank">Lucifaer</a><ul></ul><a href="http://drac0nids.top/" title="Drac0nids" target="_blank">Drac0nids</a><ul></ul><a href="http://balis0ng.com/" title="balis0ng" target="_blank">balis0ng</a><ul></ul><a href="https://da7uran0ir.github.io/" title="Da7ura_n0ir" target="_blank">Da7ura_n0ir</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"> Dad ， I will always love you.</div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" color="255,0,0" opacity="0.7" zIndex="-1" count="100" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>